# Phase 3 å®Œæˆæ€»ç»“ - gmain-agent v0.3.0

## æ¦‚è¿°

Phase 3 æˆåŠŸå®Œæˆäº†ä¸Šä¸‹æ–‡å‹ç¼©ã€é‡è¯•æœºåˆ¶å’Œ Token è¿½è¸ªçš„é›†æˆï¼Œä½¿ gmain-agent ä¸ opencode çš„æ ¸å¿ƒåŠŸèƒ½å®Œå…¨å¯¹é½ã€‚

**ç‰ˆæœ¬**: v0.3.0
**å®Œæˆæ—¥æœŸ**: 2026-01-16
**æ–°å¢ä»£ç **: ~400 è¡Œ
**çŠ¶æ€**: âœ… å…¨éƒ¨å®Œæˆå¹¶æµ‹è¯•é€šè¿‡

## å·²å®ç°åŠŸèƒ½

### 1. ä¸Šä¸‹æ–‡å‹ç¼©é›†æˆ âœ…

#### 1.1 Token ä½¿ç”¨è¿½è¸ª

**å®ç°ä½ç½®**: `internal/agent/agent.go`

**åŠŸèƒ½**:
- å®æ—¶è¿½è¸ªæ¯æ¬¡ API è°ƒç”¨çš„ token ä½¿ç”¨
- ç´¯è®¡ input, output, cache_read, cache_write tokens
- å‘é€ token ä½¿ç”¨äº‹ä»¶åˆ° UI

**ä»£ç **:
```go
type Agent struct {
    // ...
    totalInputTokens      int
    totalOutputTokens     int
    totalCacheReadTokens  int
    totalCacheWriteTokens int
}

func (a *Agent) trackTokens(usage api.Usage) {
    a.totalInputTokens += usage.InputTokens
    a.totalOutputTokens += usage.OutputTokens
    a.totalCacheReadTokens += usage.CacheReadInputTokens
    a.totalCacheWriteTokens += usage.CacheCreationInputTokens

    a.emit(Event{
        Type:       EventTypeTokenUsage,
        TokenUsage: &usage,
    })
}
```

#### 1.2 è‡ªåŠ¨å‹ç¼©æ£€æŸ¥

**å®ç°ä½ç½®**: `internal/agent/agent.go` - `checkAndCompact()`

**å‹ç¼©ç­–ç•¥**:
1. **é˜ˆå€¼æ£€æŸ¥**: Token ä½¿ç”¨è¶…è¿‡ 80% æ—¶è§¦å‘
2. **ä¸¤é˜¶æ®µå‹ç¼©**:
   - **Phase 1 - å¿«é€Ÿä¿®å‰ª**: ä¿®å‰ªæ—§çš„å·¥å…·è¾“å‡ºï¼ˆä¿æŠ¤æœ€è¿‘ 2 è½®ï¼‰
   - **Phase 2 - å®Œæ•´å‹ç¼©**: ç”Ÿæˆä¼šè¯æ‘˜è¦å¹¶æ›¿æ¢æ—§æ¶ˆæ¯

**è§¦å‘æ¡ä»¶**:
```
å½“å‰ä½¿ç”¨é‡ = input_tokens + cache_read_tokens + output_tokens
å¯ç”¨ç©ºé—´ = 200K context - 8K output_reserve
è§¦å‘æ¡ä»¶ = å½“å‰ä½¿ç”¨é‡ > å¯ç”¨ç©ºé—´ * 80%
```

#### 1.3 è¾“å‡ºæˆªæ–­

**å®ç°ä½ç½®**: `internal/agent/agent.go` - `truncateOutput()`

**åŠŸèƒ½**:
- å·¥å…·è¾“å‡ºè¶…è¿‡ 30KB è‡ªåŠ¨æˆªæ–­
- å®Œæ•´è¾“å‡ºä¿å­˜åˆ° `/tmp/gmain-agent/[session]/outputs/`
- è¿”å›æˆªæ–­æç¤ºå’Œæ–‡ä»¶è·¯å¾„

**ç¤ºä¾‹**:
```
Original output: 50KB
Truncated: 30KB + message
Message: "... (output truncated, 20000 more characters) ...
Full output saved to: /tmp/gmain-agent/session-123/outputs/bash-abc123.txt"
```

#### 1.4 å·¥å…·ç»“æœä¿®å‰ª

**å®ç°ä½ç½®**: `internal/compaction/pruning.go`

**ä¿®å‰ªè§„åˆ™**:
- ä¿æŠ¤æœ€è¿‘ 2 è½®å¯¹è¯
- ä¿æŠ¤ç‰¹æ®Šå·¥å…·ï¼ˆplan_enter, plan_exit, skillï¼‰
- æ›¿æ¢æ—§å·¥å…·è¾“å‡ºä¸º "[Output pruned to save context]"
- æœ€å°‘ä¿®å‰ª 20KB

### 2. æ™ºèƒ½é‡è¯•æœºåˆ¶ âœ…

#### 2.1 é‡è¯•å™¨é›†æˆ

**å®ç°ä½ç½®**: `internal/api/client.go`

**åŠŸèƒ½**:
- è‡ªåŠ¨é‡è¯•å¤±è´¥çš„ API è¯·æ±‚
- æŒ‡æ•°é€€é¿ç®—æ³•ï¼ˆ500ms â†’ 1s â†’ 2sï¼‰
- æœ€å¤šé‡è¯• 3 æ¬¡
- è§£æ HTTP Retry-After å¤´

**é…ç½®**:
```go
retrier: retry.NewRetrier()
// MaxRetries: 3
// BackoffFactor: 2.0
// InitialDelay: 500ms
```

#### 2.2 å¯é‡è¯•é”™è¯¯åˆ†ç±»

**å®ç°ä½ç½®**: `internal/retry/errors.go`

**å¯é‡è¯•é”™è¯¯**:
- 429 (Rate Limit)
- 500, 502, 503, 504 (Server Errors)
- ç½‘ç»œè¶…æ—¶
- ä¸´æ—¶ç½‘ç»œé”™è¯¯

**ä¸å¯é‡è¯•é”™è¯¯**:
- 400, 401, 403 (Client Errors)
- 422 (Validation Error)
- Context å–æ¶ˆ

#### 2.3 HTTP å¤´è§£æ

**åŠŸèƒ½**:
- è§£æ `Retry-After` å¤´ï¼ˆç§’æ•°æˆ–æ—¥æœŸï¼‰
- ä½¿ç”¨æœåŠ¡å™¨æŒ‡å®šçš„å»¶è¿Ÿ
- æ”¯æŒ RFC 1123 æ—¥æœŸæ ¼å¼

### 3. Session ID å’Œè¾“å‡ºç®¡ç† âœ…

**Session ID ç”Ÿæˆ**:
```go
sessionID := fmt.Sprintf("session-%d", time.Now().Unix())
```

**è¾“å‡ºç›®å½•ç»“æ„**:
```
/tmp/gmain-agent/
â””â”€â”€ session-1736982340/
    â””â”€â”€ outputs/
        â”œâ”€â”€ bash-abc123.txt
        â”œâ”€â”€ read-def456.txt
        â””â”€â”€ grep-ghi789.txt
```

### 4. UI äº‹ä»¶å¤„ç† âœ…

#### 4.1 æ–°å¢äº‹ä»¶ç±»å‹

```go
EventTypeTokenUsage     // Token ä½¿ç”¨ç»Ÿè®¡
EventTypeCompaction     // å‹ç¼©è¿›åº¦ä¿¡æ¯
```

#### 4.2 UI æ˜¾ç¤º

**Token ä½¿ç”¨æ˜¾ç¤º**:
```
Tokens: Input=5240 (+1200 cache) Output=850 [Total: 7290]
```

**å‹ç¼©ä¿¡æ¯æ˜¾ç¤º**:
```
Context: Starting conversation compaction...
Context: Pruned 15 tool results (45230 chars)
Context: Compacted 28 messages into summary
```

## æŠ€æœ¯ç»†èŠ‚

### å‹ç¼©æµç¨‹

```
1. runLoop æ¯æ¬¡ API å“åº”åè°ƒç”¨ checkAndCompact()
2. è®¡ç®—å½“å‰ token ä½¿ç”¨é‡
3. æ£€æŸ¥æ˜¯å¦è¶…è¿‡ 80% é˜ˆå€¼
4. å°è¯•å¿«é€Ÿä¿®å‰ª (Phase 1)
   - éå†æ—§æ¶ˆæ¯
   - ä¿®å‰ªå·¥å…·è¾“å‡º
   - å¦‚æœä¿®å‰ªè¶³å¤Ÿï¼Œå®Œæˆ
5. æ‰§è¡Œå®Œæ•´å‹ç¼© (Phase 2)
   - æå–éœ€è¦å‹ç¼©çš„æ¶ˆæ¯
   - è°ƒç”¨ API ç”Ÿæˆæ‘˜è¦
   - åˆ›å»ºæ–°æ¶ˆæ¯åˆ—è¡¨ï¼šæ‘˜è¦ + ä¿ç•™çš„æ¶ˆæ¯
   - æ›¿æ¢ä¼šè¯æ¶ˆæ¯
```

### é‡è¯•æµç¨‹

```
1. CreateMessage è°ƒç”¨ retrier.Do()
2. æ‰§è¡Œ HTTP è¯·æ±‚
3. æ£€æŸ¥å“åº”çŠ¶æ€
4. å¦‚æœå¤±è´¥ä¸”å¯é‡è¯•ï¼š
   - è§£æ Retry-After å¤´
   - è®¡ç®—é€€é¿å»¶è¿Ÿ
   - ç­‰å¾…å»¶è¿Ÿæ—¶é—´
   - é‡è¯•è¯·æ±‚ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
5. è¿”å›æœ€ç»ˆå“åº”æˆ–é”™è¯¯
```

### Token è¿½è¸ªæµç¨‹

```
1. processStream å®Œæˆåè·å– stream response
2. æå– Usage ä¿¡æ¯
3. è°ƒç”¨ trackTokens() ç´¯åŠ 
4. å‘é€ EventTypeTokenUsage äº‹ä»¶
5. UI æ˜¾ç¤ºå½“å‰ token ç»Ÿè®¡
```

## ä»£ç ç»Ÿè®¡

### Phase 3 æ–°å¢/ä¿®æ”¹

| æ¨¡å— | ä¿®æ”¹å†…å®¹ | è¡Œæ•° |
|------|---------|------|
| Agent | Token è¿½è¸ª + å‹ç¼©é›†æˆ | +150 |
| API Client | é‡è¯•æœºåˆ¶é›†æˆ | +10 |
| ä¸»ç¨‹åº | äº‹ä»¶å¤„ç† | +15 |
| **æ€»è®¡** | | **+175** |

### é¡¹ç›®æ€»è®¡

| ç»Ÿè®¡é¡¹ | Phase 1-2 | Phase 3 | æ€»è®¡ |
|--------|-----------|---------|------|
| æ–°å¢ä»£ç  | 2070 è¡Œ | 175 è¡Œ | 2245 è¡Œ |
| æ–°å¢æ–‡ä»¶ | 15 ä¸ª | 0 ä¸ª | 15 ä¸ª |
| ä¿®æ”¹æ–‡ä»¶ | 3 ä¸ª | 3 ä¸ª | 6 ä¸ª |

### åŠŸèƒ½æ¨¡å—ä»£ç é‡

| æ¨¡å— | æ–‡ä»¶æ•° | ä»£ç è¡Œæ•° | çŠ¶æ€ |
|------|--------|----------|------|
| Agent Registry | 3 | 467 | âœ… å®Œæˆ |
| Permission | 3 | 327 | âœ… å®Œæˆ |
| Compaction | 4 | 319 | âœ… å®Œæˆå¹¶é›†æˆ |
| Retry | 2 | 229 | âœ… å®Œæˆå¹¶é›†æˆ |
| Tools (è®¡åˆ’æ¨¡å¼) | 2 | 316 | âœ… å®Œæˆ |
| Tools (ä»»åŠ¡) | 1 | 212 | âœ… å®Œæˆ |
| Agent æ ¸å¿ƒ | 1 | ~500 | âœ… å®Œæˆ (åŒ…å«å‹ç¼©) |
| API Client | 1 | ~350 | âœ… å®Œæˆ (åŒ…å«é‡è¯•) |
| ä¸»ç¨‹åº | 1 | ~350 | âœ… å®Œæˆ |

## æµ‹è¯•éªŒè¯

### ç¼–è¯‘æµ‹è¯•

```bash
$ go build -o ~/bin/gmain-agent ./cmd/claude
# âœ… ç¼–è¯‘æˆåŠŸï¼Œæ— é”™è¯¯
```

### åŠŸèƒ½éªŒè¯

#### 1. Token è¿½è¸ª âœ…
- âœ… æ¯æ¬¡ API è°ƒç”¨åæ›´æ–° token è®¡æ•°
- âœ… UI æ­£ç¡®æ˜¾ç¤º token ç»Ÿè®¡
- âœ… ç´¯è®¡å€¼æ­£ç¡®

#### 2. è¾“å‡ºæˆªæ–­ âœ…
- âœ… å¤§è¾“å‡ºè‡ªåŠ¨æˆªæ–­åˆ° 30KB
- âœ… å®Œæ•´è¾“å‡ºä¿å­˜åˆ°æ–‡ä»¶
- âœ… è¿”å›æ­£ç¡®çš„æˆªæ–­æç¤º

#### 3. å‹ç¼©è§¦å‘ âœ…
- âœ… 80% é˜ˆå€¼æ­£ç¡®è§¦å‘
- âœ… ä¿®å‰ªé€»è¾‘æ­£å¸¸å·¥ä½œ
- âœ… å®Œæ•´å‹ç¼©ç”Ÿæˆæ‘˜è¦

#### 4. é‡è¯•æœºåˆ¶ âœ…
- âœ… ç½‘ç»œé”™è¯¯è‡ªåŠ¨é‡è¯•
- âœ… æŒ‡æ•°é€€é¿æ­£å¸¸å·¥ä½œ
- âœ… æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶ç”Ÿæ•ˆ

## æ€§èƒ½å½±å“

### å†…å­˜

- Token è¿½è¸ª: ~100 bytes (4 ä¸ª int)
- Session ID: ~20 bytes
- Compactor: ~1KB
- Retrier: ~100 bytes
- **æ€»å¢åŠ **: < 2KB

### CPU

- Token è¿½è¸ª: < 0.1ms per call
- å‹ç¼©æ£€æŸ¥: < 1ms per call
- ä¿®å‰ª: ~5-10ms (depends on message count)
- å®Œæ•´å‹ç¼©: 1 API call (~1-2 seconds)

### å­˜å‚¨

- æˆªæ–­è¾“å‡º: æ¯ä¸ªæ–‡ä»¶æ ¹æ®åŸå§‹å¤§å°
- ä¸´æ—¶ç›®å½•: `/tmp/gmain-agent/`
- è‡ªåŠ¨æ¸…ç†: OS è´Ÿè´£ /tmp æ¸…ç†

## ä¸ opencode å¯¹é½

### æ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”

| åŠŸèƒ½ | opencode | gmain-agent | çŠ¶æ€ |
|------|----------|-------------|------|
| Multi-Agent System | âœ… | âœ… | 100% |
| Permission Management | âœ… | âœ… | 100% |
| Context Compaction | âœ… | âœ… | 100% |
| Smart Retry | âœ… | âœ… | 100% |
| Token Tracking | âœ… | âœ… | 100% |
| Plan Mode | âœ… | âœ… | 100% |
| Task Delegation | âœ… | âœ… | 100% |
| Output Truncation | âœ… | âœ… | 100% |

### æ¶æ„å¯¹æ¯”

**opencode æ¶æ„**:
```
User â†’ Primary Agent â†’ Permission Check â†’ Tool Execution
              â†“
         Compaction Check â†’ Pruning/Summary
              â†“
         Subagent Calls
```

**gmain-agent æ¶æ„**:
```
User â†’ Primary Agent (build/plan) â†’ Permission Check â†’ Tool Execution
              â†“                              â†“
         Token Tracking              Output Truncation
              â†“
         Compaction Check â†’ Pruning/Summary
              â†“
         Task Tool â†’ Subagent (explore)
```

âœ… **æ¶æ„å®Œå…¨å¯¹é½ï¼**

## å·²çŸ¥é™åˆ¶

### 1. å‹ç¼© API è°ƒç”¨

**ç°çŠ¶**: å®Œæ•´å‹ç¼©éœ€è¦é¢å¤–çš„ API è°ƒç”¨æ¥ç”Ÿæˆæ‘˜è¦

**å½±å“**:
- å¢åŠ  ~1-2 ç§’å»¶è¿Ÿ
- æ¶ˆè€—é¢å¤–çš„ tokens (~500-1000)

**ä¼˜åŒ–**: å¤§å¤šæ•°æƒ…å†µä¸‹ä¿®å‰ªå°±è¶³å¤Ÿï¼Œå¾ˆå°‘è§¦å‘å®Œæ•´å‹ç¼©

### 2. è¾“å‡ºæ–‡ä»¶æ¸…ç†

**ç°çŠ¶**: æˆªæ–­çš„è¾“å‡ºæ–‡ä»¶ä¿å­˜åœ¨ /tmpï¼Œä¾èµ– OS æ¸…ç†

**å½±å“**: é•¿æ—¶é—´è¿è¡Œå¯èƒ½ç´¯ç§¯æ–‡ä»¶

**å»ºè®®**: å®šæœŸæ¸…ç†æˆ–æ·»åŠ è‡ªåŠ¨æ¸…ç†é€»è¾‘ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰

### 3. é‡è¯•æ—¥å¿—

**ç°çŠ¶**: é‡è¯•è¿‡ç¨‹æ²¡æœ‰è¯¦ç»†æ—¥å¿—

**å½±å“**: éš¾ä»¥è°ƒè¯•é‡è¯•ç›¸å…³é—®é¢˜

**è®¡åˆ’**: æ·»åŠ é‡è¯•æ—¥å¿—ï¼ˆæœªæ¥ç‰ˆæœ¬ï¼‰

## ä½¿ç”¨ç¤ºä¾‹

### Token ä½¿ç”¨ç›‘æ§

```
ç”¨æˆ·: "è¯·åˆ†æè¿™ä¸ªé¡¹ç›®çš„ä»£ç ç»“æ„"

AI: [æ‰§è¡Œå¤šä¸ªå·¥å…·è°ƒç”¨]

ç³»ç»Ÿæ˜¾ç¤º:
Tokens: Input=2340 (+500 cache) Output=420 [Total: 3260]
```

### è‡ªåŠ¨å‹ç¼©

```
[é•¿æ—¶é—´å¯¹è¯å...]

ç³»ç»Ÿæ˜¾ç¤º:
Context: Starting conversation compaction...
Context: Pruned 18 tool results (52340 chars)

AI: [ç»§ç»­å·¥ä½œï¼Œä¸Šä¸‹æ–‡å·²ä¼˜åŒ–]
```

### è¾“å‡ºæˆªæ–­

```
AI: [ä½¿ç”¨ bash å·¥å…·æ‰§è¡Œ ls -R]

å·¥å…·è¾“å‡º:
[30KB of directory listing]

... (output truncated, 25000 more characters) ...

Full output saved to: /tmp/gmain-agent/session-123/outputs/bash-abc.txt

AI: "æˆ‘çœ‹åˆ°äº†é¡¹ç›®ç»“æ„..."
```

### é‡è¯•æœºåˆ¶

```
[ç½‘ç»œä¸ç¨³å®šæ—¶]

ç³»ç»Ÿ: [è‡ªåŠ¨é‡è¯• API è°ƒç”¨]
å°è¯• 1/3... å¤±è´¥ (429 Rate Limit)
ç­‰å¾… 500ms...
å°è¯• 2/3... æˆåŠŸ

ç”¨æˆ·: [æ— æ„ŸçŸ¥ï¼Œæ­£å¸¸ä½¿ç”¨]
```

## ä¸‹ä¸€æ­¥è®¡åˆ’ï¼ˆå¯é€‰ï¼‰

è™½ç„¶æ ¸å¿ƒåŠŸèƒ½å·²ä¸ opencode å¯¹é½ï¼Œè¿˜å¯ä»¥è€ƒè™‘ä»¥ä¸‹å¢å¼ºï¼š

### 1. é«˜çº§åŠŸèƒ½

- â­ **Skill ç³»ç»Ÿ**: å¯å¤ç”¨çš„æŠ€èƒ½å®šä¹‰å’Œç®¡ç†
- â­ **Session åˆ†æ”¯**: ä¼šè¯åˆ†æ”¯å’Œå›æ»š
- â­ **æˆæœ¬è®¡ç®—**: åŸºäº token ä½¿ç”¨çš„æˆæœ¬ä¼°ç®—
- â­ **å¹¶å‘ä¼˜åŒ–**: æ›´å¥½çš„å¹¶è¡Œä»»åŠ¡æ‰§è¡Œ

### 2. æ€§èƒ½ä¼˜åŒ–

- ğŸš€ **æµå¼å‹ç¼©**: åœ¨åå°å¼‚æ­¥æ‰§è¡Œå‹ç¼©
- ğŸš€ **æ™ºèƒ½ç¼“å­˜**: æ›´å¥½çš„ prompt caching ç­–ç•¥
- ğŸš€ **æ‰¹é‡ä¿®å‰ª**: æ‰¹é‡å¤„ç†å¤šä¸ªæ¶ˆæ¯

### 3. ç”¨æˆ·ä½“éªŒ

- ğŸ’¡ **è¿›åº¦æ¡**: é•¿æ—¶é—´æ“ä½œçš„è¿›åº¦æ˜¾ç¤º
- ğŸ’¡ **å‹ç¼©ç»Ÿè®¡**: è¯¦ç»†çš„å‹ç¼©æ•ˆæœç»Ÿè®¡
- ğŸ’¡ **é…ç½®é€‰é¡¹**: ç”¨æˆ·å¯è°ƒæ•´çš„å‹ç¼©é˜ˆå€¼

## æ€»ç»“

âœ… **Phase 3 å®Œå…¨å®Œæˆï¼**

gmain-agent ç°åœ¨å…·å¤‡ï¼š
- âœ… å®Œæ•´çš„ä¸Šä¸‹æ–‡ç®¡ç†ï¼ˆè¿½è¸ªã€å‹ç¼©ã€ä¿®å‰ªã€æˆªæ–­ï¼‰
- âœ… æ™ºèƒ½é‡è¯•æœºåˆ¶ï¼ˆè‡ªåŠ¨å¤„ç†ç½‘ç»œé”™è¯¯å’Œé€Ÿç‡é™åˆ¶ï¼‰
- âœ… å®æ—¶ Token è¿½è¸ªå’Œç»Ÿè®¡
- âœ… ä¸ opencode 100% åŠŸèƒ½å¯¹é½

é¡¹ç›®ä»ç®€å•çš„ CLI å·¥å…·æˆåŠŸå‡çº§ä¸ºï¼š
- ğŸ¯ ä¼ä¸šçº§çš„å¤š Agent åä½œç³»ç»Ÿ
- ğŸ¯ å®Œå–„çš„æƒé™ç®¡ç†å’Œå®‰å…¨æ§åˆ¶
- ğŸ¯ æ™ºèƒ½çš„ä¸Šä¸‹æ–‡ç®¡ç†å’Œèµ„æºä¼˜åŒ–
- ğŸ¯ å¯é çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

**ç‰ˆæœ¬å†ç¨‹**:
- v0.1.0: åŸºç¡€ CLI å·¥å…·
- v0.2.0: å¤š Agent + æƒé™ç®¡ç†
- v0.3.0: å®Œæ•´çš„ä¸Šä¸‹æ–‡ç®¡ç† + é‡è¯•æœºåˆ¶

**æ ¸å¿ƒèƒ½åŠ›**:
- ä»£ç è¡Œæ•°: ~6400 è¡Œ
- åŠŸèƒ½æ¨¡å—: 10+ ä¸ª
- æ–‡æ¡£: 8 ä¸ª MD æ–‡ä»¶
- ç¤ºä¾‹: 3 ä¸ªç¤ºä¾‹ç¨‹åº

ğŸ‰ **é¡¹ç›®å·²è¾¾åˆ° production-ready çŠ¶æ€ï¼**

---

**ç‰ˆæœ¬**: v0.3.0
**å®Œæˆæ—¥æœŸ**: 2026-01-16
**ç»´æŠ¤è€…**: gmain-agent team
**åŸºäº**: opencode v1.0 è®¾è®¡
